---
// استيراد ملف التنسيق الخاص بكِ
import '../styles/style.css';
---

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول - علي كيرنل</title>
    <link rel="icon" type="image/x-icon" href="https://www.alikernel.com/favicon.ico">
</head>
<body>
    <div class="fullscreen-modal">
        <a href="https://www.alikernel.com" class="modal-close-btn" title="إغلاق">
            <svg viewBox="0 0 24 24"><path d="M9.57 5.92993L3.5 11.9999L9.57 18.0699" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path><path d="M20.5 12H3.67004" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path></svg>
        </a>
        <div class="login-container">
            <div class="login-header">
                <svg class="site-logo-placeholder" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124 124" fill="none"><rect width="124" height="124" rx="24" fill="#f97316"/><path d="M19.375 36.782v63.843a4 4 0 0 0 4 4h63.843c3.564 0 5.348-4.309 2.829-6.828L26.203 33.953c-2.52-2.52-6.828-.735-6.828 2.829" fill="#fff"/><circle cx="63.211" cy="37.539" r="18.164" fill="#000"/><rect opacity=".4" x="81.133" y="80.72" width="17.569" height="17.388" rx="4" transform="rotate(-45 81.133 80.72)" fill="#fdba74"/></svg>
                <span>علي كيرنل</span>
            </div>
            <div class="login-card">
                <h2>أهلاً بعودتك</h2>
                <p>سجل دخولك باستخدام حسابك الاجتماعي</p>
                
                <button class="social-btn" id="google-signin-btn">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"></path></svg>
                    <span>الدخول باستخدام Google</span>
                </button>
                
                <button class="social-btn" id="github-signin-btn">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg>
                    <span>الدخول باستخدام GitHub</span>
                </button>
            </div>
            <div class="login-footer">
                <p>بالنقر على "متابعة"، فإنك توافق على <a href="#">شروط الخدمة</a> و <a href="#">سياسة الخصوصية</a>.</p>
            </div>
        </div>
    </div>

    <script>
// ========================================================
// Better Auth Manager مع Pusher للخروج الفوري
// ========================================================
// سكربت الاستعادة الفوري (لمنع وميض الهيدر)
// ========================================================
(function() {
    try {
        var photoURL = localStorage.getItem("userPhotoURL");
        var lastUid = localStorage.getItem("last_uid");
        var userAvatarIcon = document.getElementById("user-avatar-icon");
        var profileIcon = document.getElementById("profile-icon");
        var userMenu = document.getElementById("user-menu");
        var guestMenu = document.getElementById("guest-menu");
        var accountAvatar = document.getElementById("account-avatar");

        if (lastUid && photoURL && photoURL !== "null") {
            if (userAvatarIcon) {
                userAvatarIcon.src = photoURL;
                userAvatarIcon.classList.remove("hidden");
                userAvatarIcon.style.setProperty('display', 'block', 'important');
            }
            if (profileIcon) {
                profileIcon.classList.add("hidden");
                profileIcon.style.setProperty('display', 'none', 'important');
            }
            if (userMenu) userMenu.style.setProperty('display', 'block', 'important');
            if (guestMenu) guestMenu.style.setProperty('display', 'none', 'important');
            if (accountAvatar) accountAvatar.src = photoURL;
        } else {
            if (userAvatarIcon) {
                userAvatarIcon.style.setProperty('display', 'none', 'important');
                userAvatarIcon.classList.add("hidden");
            }
            if (profileIcon) {
                profileIcon.style.setProperty('display', 'block', 'important');
                profileIcon.classList.remove("hidden");
            }
            if (userMenu) userMenu.style.setProperty('display', 'none', 'important');
            if (guestMenu) guestMenu.style.setProperty('display', 'block', 'important');
        }

        var accountName = document.getElementById("account-name");
        var accountEmail = document.getElementById("account-email");
        var accountJoined = document.getElementById("account-joined-date");
        var sessionsList = document.getElementById("sessions-list");

        var cachedName = localStorage.getItem("userDisplayName");
        var cachedEmail = localStorage.getItem("userEmail");
        var cachedJoined = localStorage.getItem("userJoinedDate");
        var cachedSessions = localStorage.getItem("userSessionsHTMLCache");

        if (cachedName && accountName) accountName.textContent = cachedName;
        if (cachedEmail && accountEmail) accountEmail.textContent = cachedEmail;
        if (cachedJoined && accountJoined) accountJoined.textContent = cachedJoined;
        if (cachedSessions && sessionsList && sessionsList.children.length === 0) {
            sessionsList.innerHTML = cachedSessions;
        }
    } catch (e) {}
})();

// ========================================================
// الكود الرئيسي - Better Auth Manager
// ========================================================
(function() {
    class BetterAuthManager {
        constructor() {
            window.betterAuth = this;
            this.isInitialized = false;
            this._deletingSession = false;
            this._isSigningIn = false;
            this.sessionCheckInterval = null;

            this.config = {
                apiUrl: "https://alikernel-auth.vercel.app/api/auth",
                googleClientId: "617149480177-aimcujc67q4307sk43li5m6pr54vj1jv.apps.googleusercontent.com",
                paths: {
                    home: "https://www.alikernel.com",
                    account: "https://www.alikernel.com/account",
                    login: "https://www.alikernel.com/login"
                }
            };

            this.icons = {
                clock: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v6l4 2"></path><circle cx="12" cy="12" r="10"></circle></svg>',
                device: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h8"></path><path d="M10 19v-3.96 3.15"></path><path d="M7 19h5"></path><rect width="6" height="10" x="16" y="12" rx="2"></rect></svg>',
                location: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path><circle cx="12" cy="10" r="3"></circle></svg>',
                globe: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"></path><path d="M7.99998 3H8.99998C7.04998 8.84 7.04998 15.16 8.99998 21H7.99998"></path><path d="M15 3C16.95 8.84 16.95 15.16 15 21"></path><path d="M3 16V15C8.84 16.95 15.16 16.95 21 15V16"></path><path d="M3 9.0001C8.84 7.0501 15.16 7.0501 21 9.0001"></path></svg>',
                check: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 4L9 15"></path><path d="M21 19L3 19"></path><path d="M9 15L4 10"></path></svg>'
            };

            this.setupCrossTabSync();
            this.setupBeforeUnload();
            this.bindUserActions();
            this.init();
        }

        init() {
            var self = this;
            if (this.isInitialized) return;

            this.getCurrentSession().then(function(session) {
                var path = window.location.href;

                if (session && session.user) {
                    if (path.includes('/login')) {
                        window.location.href = self.config.paths.home;
                        return;
                    }
                    self.cacheUserData(session.user);
                    self.updateHeaderUI(session.user);
                    self.setupAccountPage(session.user);
                    self.handleSessionSync(session.user);
                    self.startSessionPolling();
                } else {
                    if (path.includes('/account')) {
                        window.location.href = self.config.paths.login;
                        return;
                    }
                    self.showGuestUI();
                    self.setupGoogleOneTap();
                }

                self.isInitialized = true;
            }).catch(function() {
                self.showGuestUI();
            });
        }

        getCurrentSession() {
            var self = this;
            return fetch(self.config.apiUrl + '/get-session', {
                credentials: 'include'
            }).then(function(res) {
                if (!res.ok) return null;
                return res.json();
            }).then(function(data) {
                if (data && data.user) return data;
                return null;
            }).catch(function() {
                return null;
            });
        }

        cacheUserData(user) {
            var photo = user.image || null;
            var name = user.name || (user.email ? user.email.split('@')[0] : 'مستخدم');
            if (photo) localStorage.setItem("userPhotoURL", photo);
            localStorage.setItem("userDisplayName", name);
            localStorage.setItem("userEmail", user.email || '');
            localStorage.setItem("last_uid", user.id);
            if (user.createdAt) {
                var date = new Date(user.createdAt);
                var formatted = date.toLocaleString('ar-u-nu-latn', {
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: 'numeric', minute: 'numeric', hour12: true
                }).replace('ص', 'صباحاً').replace('م', 'مساءً');
                localStorage.setItem("userJoinedDate", "انضم في: " + formatted);
            }
        }

        clearCache() {
            localStorage.removeItem("userPhotoURL");
            localStorage.removeItem("userDisplayName");
            localStorage.removeItem("userEmail");
            localStorage.removeItem("userJoinedDate");
            localStorage.removeItem("userSessionsHTMLCache");
            localStorage.removeItem("last_uid");
            localStorage.removeItem("betterAuthSessionId");
        }

        showGuestUI() {
            var ic = document.getElementById("profile-icon");
            var av = document.getElementById("user-avatar-icon");
            var um = document.getElementById("user-menu");
            var gm = document.getElementById("guest-menu");
            if (ic) { ic.style.setProperty('display', 'block', 'important'); ic.classList.remove("hidden"); }
            if (av) { av.style.setProperty('display', 'none', 'important'); av.classList.add("hidden"); av.src = ""; }
            if (um) um.style.setProperty('display', 'none', 'important');
            if (gm) gm.style.setProperty('display', 'block', 'important');
        }

        updateHeaderUI(user) {
            var av = document.getElementById("user-avatar-icon");
            var ic = document.getElementById("profile-icon");
            var um = document.getElementById("user-menu");
            var gm = document.getElementById("guest-menu");
            var photo = user.image || null;
            if (photo && av) {
                av.src = photo;
                av.style.setProperty('display', 'block', 'important');
                av.classList.remove("hidden");
                av.setAttribute("referrerpolicy", "no-referrer");
                if (ic) { ic.style.setProperty('display', 'none', 'important'); ic.classList.add("hidden"); }
            }
            if (um) um.style.setProperty('display', 'block', 'important');
            if (gm) gm.style.setProperty('display', 'none', 'important');
        }

        setupAccountPage(user) {
            var av = document.getElementById("account-avatar");
            if (av && user.image) av.src = user.image;
            this.updateUserInfo(user);
            var list = document.getElementById("sessions-list");
            if (list) this.refreshSessionsUI(user);
            var content = document.getElementById('account-content');
            if (content) { content.classList.add('loaded'); content.style.opacity = '1'; }
        }

        updateUserInfo(user) {
            var nameEl = document.getElementById("account-name");
            if (nameEl) nameEl.textContent = user.name || (user.email ? user.email.split('@')[0] : 'مستخدم');
            var emailEl = document.getElementById("account-email");
            if (emailEl) emailEl.textContent = user.email || '';
            var joinedEl = document.getElementById("account-joined-date");
            if (joinedEl && user.createdAt) {
                var date = new Date(user.createdAt);
                var formatted = date.toLocaleString('ar-u-nu-latn', {
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: 'numeric', minute: 'numeric', hour12: true
                }).replace('ص', 'صباحاً').replace('م', 'مساءً');
                joinedEl.textContent = "انضم في: " + formatted;
            }
        }

        refreshSessionsUI(user) {
            var self = this;
            var list = document.getElementById("sessions-list");
            if (!list) return;
            fetch(self.config.apiUrl + '/list-sessions', { credentials: 'include' })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var sessions = data.sessions || [];
                    if (sessions.length > 0) {
                        var sid = localStorage.getItem("betterAuthSessionId");
                        var htmlContent = sessions.map(function(s) {
                            var isCurr = s.id === sid;
                            var time = new Date(s.createdAt).toLocaleString('ar-u-nu-latn', {
                                hour: 'numeric', minute: 'numeric', hour12: true
                            }).replace('ص', 'AM').replace('م', 'PM');
                            var domainLine = s.domain ? '<div class="session-detail-line">' + self.icons.globe + ' <span>الموقع: ' + self.escapeHtml(s.domain) + '</span></div>' : '';
                            return '<div class="session-item" id="session-' + s.id + '">' +
                                '<div class="session-details">' +
                                    '<div class="session-detail-line">' + self.icons.clock + ' <span>الوقت: ' + time + '</span></div>' +
                                    '<div class="session-detail-line">' + self.icons.device + ' <span>نظام التشغيل: ' + self.escapeHtml(s.os || 'Unknown') + '</span></div>' +
                                    '<div class="session-detail-line">' + self.icons.location + ' <span>العنوان: ' + self.escapeHtml(s.ip || 'Unknown') + '</span></div>' +
                                    domainLine +
                                    (isCurr ? '<div class="session-detail-line current-session-indicator">' + self.icons.check + ' <span>جلستك الحالية</span></div>' : '') +
                                '</div>' +
                                '<button class="terminate-btn ' + (isCurr ? 'icon-current' : 'icon-terminate') + '" onclick="window.betterAuth.handleDeleteSession(\'' + s.id + '\')"></button>' +
                            '</div>';
                        }).join('');
                        localStorage.setItem("userSessionsHTMLCache", htmlContent);
                        list.innerHTML = htmlContent;
                    } else {
                        list.innerHTML = '<p style="text-align:center;color:#888;">لا توجد جلسات نشطة</p>';
                    }
                }).catch(function() {});
        }

        escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        setupCrossTabSync() {
            var self = this;
            window.addEventListener('storage', function(event) {
                if (event.key === 'last_uid') {
                    if (!event.newValue && event.oldValue) self.showGuestUI();
                    else if (event.newValue !== event.oldValue) location.reload();
                }
                if (event.key === 'session_deleted') {
                    if (event.newValue === localStorage.getItem("betterAuthSessionId")) {
                        self.forceLogout();
                    }
                }
            });
        }

        setupBeforeUnload() {
            var self = this;
            window.addEventListener('beforeunload', function() {
                if (self.sessionCheckInterval) clearInterval(self.sessionCheckInterval);
            });
        }

        bindUserActions() {
            var self = this;
            var observer = new MutationObserver(function() {
                var logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn && !logoutBtn.hasAttribute('data-bound')) {
                    logoutBtn.setAttribute('data-bound', 'true');
                    logoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        self.localLogout();
                    }, true);
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });

            document.addEventListener('click', function(e) {
                var target = e.target.closest('button, a');
                if (!target) return;
                if (target.id === "logout-btn" || target.textContent.includes("خروج") || target.textContent.includes("الخروج")) {
                    e.preventDefault();
                    e.stopPropagation();
                    self.localLogout();
                    return;
                }
                if (target.id === "google-signin-btn" || target.id === "google-signin-btn-popup") {
                    e.preventDefault();
                    self.loginWithGoogle();
                    return;
                }
                if (target.id === "github-signin-btn") {
                    e.preventDefault();
                    self.loginWithGitHub();
                    return;
                }
            }, true);
        }

        loginWithGoogle() {
            window.location.href = this.config.apiUrl + '/sign-in/social/google?callbackURL=' + encodeURIComponent(this.config.paths.home);
        }

        loginWithGitHub() {
            window.location.href = this.config.apiUrl + '/sign-in/social/github?callbackURL=' + encodeURIComponent(this.config.paths.home);
        }

        localLogout() {
            var self = this;
            fetch(self.config.apiUrl + '/sign-out', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            }).then(function() {
                self.finishLogout();
            }).catch(function() {
                self.finishLogout();
            });
        }

        forceLogout() {
            var self = this;
            this.clearCache();
            this.showGuestUI();
            fetch(self.config.apiUrl + '/sign-out', { method: 'POST', credentials: 'include' })
                .then(function() { self.doRedirect(); })
                .catch(function() { self.doRedirect(); });
        }

        finishLogout() {
            this.clearCache();
            this.showGuestUI();
            this.doRedirect();
        }

        doRedirect() {
            if (window.location.href.includes('/account')) {
                window.location.href = this.config.paths.login;
            } else {
                location.reload();
            }
        }

        handleSessionSync(user) {
            var self = this;
            var os = this.getOS();
            var fingerprint = this.getDeviceFingerprint();
            this.fetchIP().then(function(ip) {
                fetch(self.config.apiUrl + '/sync-session', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fingerprint: fingerprint, os: os, ip: ip, domain: window.location.hostname })
                }).then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.sessionId) localStorage.setItem("betterAuthSessionId", data.sessionId);
                }).catch(function() {});
            });
        }

        startSessionPolling() {
            var self = this;
            this.sessionCheckInterval = setInterval(function() {
                self.getCurrentSession().then(function(session) {
                    if (!session) self.forceLogout();
                });
            }, 30000);
        }

        handleDeleteSession(id) {
            var self = this;
            if (this._deletingSession) return;
            var sid = localStorage.getItem("betterAuthSessionId");
            var isCurrent = id === sid;
            var msg = isCurrent ? "سيتم تسجيل خروجك من هذا الجهاز فوراً." : "هل تريد إزالة هذا الجهاز من قائمة الأجهزة المتصلة؟";
            this.showModalConfirm(msg, function() {
                if (self._deletingSession) return;
                self._deletingSession = true;
                if (isCurrent) {
                    self.localLogout();
                } else {
                    fetch(self.config.apiUrl + '/delete-session', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId: id })
                    }).then(function() {
                        localStorage.setItem('session_deleted', id);
                        setTimeout(function() { localStorage.removeItem('session_deleted'); }, 100);
                        setTimeout(function() { self._deletingSession = false; }, 1000);
                        self.getCurrentSession().then(function(session) {
                            if (session && session.user) self.refreshSessionsUI(session.user);
                        });
                    }).catch(function() { self._deletingSession = false; });
                }
            });
        }

        fetchIP() {
            return new Promise(function(resolve) {
                var controller = new AbortController();
                setTimeout(function() { controller.abort(); }, 3000);
                fetch('https://api.ipify.org?format=json', { signal: controller.signal })
                    .then(function(res) { return res.json(); })
                    .then(function(data) { resolve(data.ip || "Unknown"); })
                    .catch(function() { resolve("Unknown"); });
            });
        }

        showModalConfirm(msg, cb) {
            var modal = document.getElementById("custom-confirm-modal");
            if (!modal) { if (confirm(msg) && cb) cb(); return; }
            var text = document.getElementById("custom-modal-text");
            var confirmBtn = document.getElementById("custom-modal-confirm-btn");
            var cancelBtn = document.getElementById("custom-modal-cancel-btn");
            text.textContent = msg;
            modal.classList.remove("hidden");
            var newConfirmBtn = confirmBtn.cloneNode(true);
            var newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newConfirmBtn.onclick = function() { modal.classList.add("hidden"); if (cb) cb(); };
            newCancelBtn.onclick = function() { modal.classList.add("hidden"); };
        }

        setupGoogleOneTap() {
            var self = this;
            if (localStorage.getItem("last_uid")) return;
            if (window.location.href.includes('/account')) return;

            var loadGoogle = function() {
                if (!window.google || !window.google.accounts) {
                    setTimeout(loadGoogle, 500);
                    return;
                }
                self.generateNonce().then(function(nonceData) {
                    var nonce = nonceData[0];
                    var hashedNonce = nonceData[1];
                    if (!nonce || !hashedNonce) return;

                    window.handleGoogleSignIn = function(response) {
                        if (self._isSigningIn) return;
                        self._isSigningIn = true;
                        if (!response || !response.credential) { self._isSigningIn = false; return; }
                        fetch(self.config.apiUrl + '/sign-in/social/google/callback', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ idToken: response.credential, nonce: nonce })
                        }).then(function(res) { return res.json(); })
                        .then(function(result) {
                            if (result.error) { alert('فشل تسجيل الدخول: ' + result.error); self._isSigningIn = false; return; }
                            if (result.user) {
                                self.cacheUserData(result.user);
                                self.updateHeaderUI(result.user);
                                self.handleSessionSync(result.user);
                                try { window.google.accounts.id.cancel(); } catch(e) {}
                                setTimeout(function() {
                                    if (window.location.href.includes('/login')) window.location.href = self.config.paths.home;
                                    else location.reload();
                                }, 300);
                            }
                        }).catch(function() { self._isSigningIn = false; });
                    };

                    window.google.accounts.id.initialize({
                        client_id: self.config.googleClientId,
                        callback: window.handleGoogleSignIn,
                        nonce: hashedNonce,
                        auto_select: false,
                        cancel_on_tap_outside: true,
                        use_fedcm_for_prompt: true,
                        context: 'signin'
                    });
                    window.google.accounts.id.prompt();
                });
            };
            loadGoogle();
        }

        generateNonce() {
            var self = this;
            return new Promise(function(resolve) {
                try {
                    var nonce = btoa(String.fromCharCode.apply(null, crypto.getRandomValues(new Uint8Array(32))));
                    var encoder = new TextEncoder();
                    crypto.subtle.digest('SHA-256', encoder.encode(nonce)).then(function(hashBuffer) {
                        var hashedNonce = Array.from(new Uint8Array(hashBuffer)).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
                        self.currentNonce = nonce;
                        self.currentHashedNonce = hashedNonce;
                        resolve([nonce, hashedNonce]);
                    });
                } catch(e) { resolve([null, null]); }
            });
        }

        getDeviceFingerprint() {
            try {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.fillText('FP', 2, 15);
                var fpData = [navigator.userAgent, navigator.language, screen.colorDepth, screen.width + 'x' + screen.height, new Date().getTimezoneOffset(), navigator.hardwareConcurrency || 0, canvas.toDataURL().substring(0, 100)].join('|');
                var hash = 0;
                for (var i = 0; i < fpData.length; i++) { hash = ((hash << 5) - hash) + fpData.charCodeAt(i); hash = hash & hash; }
                return 'fp_' + Math.abs(hash).toString(36);
            } catch(e) { return 'fp_fallback_' + Date.now().toString(36); }
        }

        getOS() {
            var ua = navigator.userAgent;
            if (/Android/i.test(ua)) return "أندرويد";
            if (/iPhone/i.test(ua)) return "آيفون";
            if (/iPad/i.test(ua)) return "آيباد";
            if (/Windows/i.test(ua)) return "ويندوز";
            if (/Mac/i.test(ua)) return "ماك";
            if (/Linux/i.test(ua)) return "لينكس";
            return "جهاز غير معروف";
        }
    }

    // تحميل Google SDK ثم تشغيل المدير
    var googleScript = document.createElement('script');
    googleScript.src = 'https://accounts.google.com/gsi/client';
    googleScript.async = true;
    googleScript.defer = true;
    document.body.appendChild(googleScript);

    new BetterAuthManager();
})();
</script>
</body>
</html>

